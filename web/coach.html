<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <script src="./offline_lib/jquery-3.4.1.js"></script>
    <script src="./offline_lib/jquery.csv.min.js"></script>
    <script src="./offline_lib/math.min.js"></script>

    <script src="./offline_lib/svgjs/svg.js"></script>

    <script src="./js/util.js"></script>
    <script src="./js/cart_pole.js"></script>
    <script src="./js/cartpole_viewer.js"></script>
    <script src="./js/ui_blocks.js"></script>

    <script src="./sim_runs/data0.js"></script>
    <script src="./js/main.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>

    <link rel="stylesheet" href="./css/cartpole.css">
  </HEAD>
  <BODY>

      <script>
        function negativeFeedback() {
          python_ws.send("Connection established");

          console.log("-1");
        }

        function positiveFeedback() {
          python_ws.send("Connection established");

          console.log("+1");
        }
      </script>

      <h2>Train Cartpole using COACH</h2>

      <div class="grid-container" id="cartpole_instance"></div>

      <div id=feedbackButtons></div>

      <div id=gridDiv>
        <h2 class="title"></h2>
        <h4 class="policy"></h4>
        <b class="descript"></b>
        <div class="grid-container animation-container"></div>
      </div>


      <script>

          $(document).ready(function() {
            var img_width = 300, img_height = 100
            var cp = null
            var python_ws = new WebSocket("ws://localhost:8000/echo")

            python_ws.onopen = function(msg) {
              // Web Socket is connected, send data using send()
              python_ws.send("Connection established");
            };

            python_ws.onmessage = function (evt) {
              var received_msg = JSON.parse(evt.data);
              console.log("Received message: " + received_msg)

              var done = cp.update(received_msg["action"])

              console.log(done)
              if (done) {
                console.log("Episode finished")
                cp.reset()
              }

              // TODO: convert this to a standalone function
              $("#drawing").empty()
              cp.viewer.gen_img("#drawing", cp.getState(false), img_width, img_height)

            };

            python_ws.onclose = function() {
              // websocket is closed.
              console.log("Connection is closed...");
            };


            var badBtn = document.createElement("button");
            badBtn.innerHTML = "Bad";
            badBtn.onclick = function(){

              var msg = {
                msg_type: "feedback",
                reward: -1,
                state: cp.getState()
              }

              msg = JSON.stringify(msg)
              python_ws.send(msg);
            }


            var goodBtn = document.createElement("button");
            goodBtn.innerHTML = "Good";
            goodBtn.onclick = function(){
              var msg = {
                msg_type: "feedback",
                reward: 1,
                state: cp.getState()
              }

              msg = JSON.stringify(msg)
              python_ws.send(msg);
            }

            var body = document.getElementById("feedbackButtons");
            body.appendChild(badBtn);
            body.appendChild(goodBtn);




            //===========< init sim & viewer thresholds >====================//
            //thesholds for x & theta (radians)
            //goes from (-val, +val)
            var cartpole_thresholds = { x : 2.4,
                                        theta : 24 * Math.PI / 180, // = 0.41887902047863906
                                      }
            var cartpoleSim  = new CartPole(cartpole_thresholds)
            var ui_blocks = new UI_Blocks()

            //===========< choose policy & generate states for grid>====================//

            cp = new CartPole(cartpole_thresholds = cartpole_thresholds, state_as_arr = null, title = null, starting_state = true)

            ui_blocks.individual_episode("#cartpole_instance", cp)

            var cp_state = JSON.stringify(cp.getState())
            python_ws.onopen = () => python_ws.send(cp_state);

          });

          $(document).ready(function() {
            let main = new Main()
            main.run()
          })

      </script>
  </BODY>
</HTML>
